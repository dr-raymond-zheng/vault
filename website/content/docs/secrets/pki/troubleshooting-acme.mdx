---
layout: docs
page_title: 'PKI - Secrets Engine: Troubleshooting ACME'
description: The PKI secrets engine for Vault generates TLS certificates.
---

# PKI Secrets Engine - Troubleshooting ACME

Solve common problems related to ACME client integration.

## Contacting support

When contacting Hashicorp Support with ACME related issues or filing a
GitHub issue, the following pieces of information are helpful for Support
and Engineering to investigate and reproduce any issues related to ACME,
in addition to the regularly asked pieces of information:

 - **ACME client name and version**; different clients behave differently
   and certain ACME clients might have bugs or other shortcomings at
   particular versions.
 - **ACME client logs**, if any; on failure, `certbot` will give the location
   of debug logs it has produced while attempting to request certificates.
   This frequently contains helpful information about requests to the Vault
   cluster and the server's response. Other clients may or may not behave
   similarly; in the event of not having log information, full output in
   verbose (or debug mode) of the client would be helpful.
 - **Vault server DEBUG level logs**; many ACME errors are hidden from the
   client as they contain sensitive information, but are instead logged,
   when appropriate, to the server logs at a DEBUG level.

## Debugging cluster path issues

If ACME works on some nodes of a Vault Enterprise cluster but not on
others, likely it means that the cluster address has not been set.

### Symptoms

When reading the ACME config on these Performance Secondary nodes, a
warning might appear like:

> ACME feature requires local cluster 'path' field configuration to be set

When attempting to contact such a node with an ACME client, a server internal
error will appear with the above message as well.

### Resolution

For each Performance Replication cluster, read the value of `/config/cluster`
and ensure the `path` field is set. When it is missing, update the URL to
point to this mount's path on a TLS-enabled address for this PR cluster; this
domain may be a load balanced or a DNS round robin address. For example:

```
$ vault write pki/config/cluster path=https://cluster-b.vault.example.com/v1/pki
```

Once this is done, re-read the ACME configuration and make sure no warnings
appear:

```
$ vault read pki/config/acme
```

## Debugging account registration failures

If a server has been updated to require `eab_policy=always-required` in the
[ACME configuration](/vault/api-docs/secret/pki#set-acme-configuration),
new account registration (and reuse of existing accounts will fail).

### Symptoms

When registering a new account without an [External Account Binding
(EAB)](/vault/api-docs/secret/pki#acme-external-account-bindings), the
Vault Server will reject the request with a response like:

> Unable to register an account with ACME server

with further information provided in the debug logs (in the case of
`certbot`):

> Server requires external account binding.

or, if the client incorrectly contacted the server, an error like:

> The request must include a value for the 'externalAccountBinding' field

In either case, a new account needs to be created with an EAB token created
by Vault.

### Resolution

Using a Vault token, [fetch a new external account
binding](/vault/api-docs/secret/pki#get-acme-eab-binding-token) for
the [desired directory](/vault/api-docs/v1.14.x/secret/pki#acme-directories):

```
$ vault write -f pki/roles/my-role-name/acme/new-eab
...
directory roles/my-role-name/acme/directory
id        bc8088d9-3816-5177-ae8e-d8393265f7dd
key       MHcCAQE... additional data elided ...
...
```

Then pass these fields into the ACME client. For example, with `certbot`:

```
$ certbot [... additional parameters ...] \
    --server https://cluster-b.vault.example.com/v1/pki/roles/my-role-name/acme/directory \
    --eab-kid bc8088d9-3816-5177-ae8e-d8393265f7dd \
    --eab-hmac-key MHcCAQE... additional data elided ...
```

Ensure that the ACME directory passed to the ACME client matches that
fetched from the Vault.

## Debugging EAB directory bindings

If an EAB account token is incorrectly used with the wrong directory, the
ACME server will reject the request with an error about insufficient
permissions.

### Symptoms

When initializing a new account against this Vault server, an error might
appear like:

> The client lacks sufficient authorization :: failed to verify eab

This is caused by requesting an EAB from a directory not matching the
one the client used.

### Resolution

Ensure the requested EAB token matches the directory. For a given directory
at `/some/path/acme/directory`, fetch EAB tokens from
`/some/path/amce/new-eab`. The remaining resolution steps are the same as
for [debugging account registration
failures](#debugging-account-registration-failures).

## Debugging issuance failures

When Vault can't verify the server's identity through the client's requested
[challenge type](/vault/api-docs/secret/pki#acme-challenge-types) (`dns-01`,
`http-01`, or `tls-alpn-01`), Vault will not issue the certificate requested
by the client.

### Symptoms

In the Vault logs or returned by the client, an error might occur like:

> ACME validation failed for a465a798-4400-6c17-6735-e1b38c23de38-tls-alpn-01: ...

this indicates that the server was unable to validate this challenge accepted
by the client.

### Resolution

Ensure that DNS is configured correctly from the Vault server's perspective,
including setting [any custom DNS resolver](/vault/api-docs/secret/pki#dns_resolver).

Ensure that any firewalls are set up to allow Vault to talk to the relevant
systems (the DNS server in the case of `dns-01`, port 80 on the target
machine for `http-01`, or port 443 on the target machine for `tls-alpn-01`
challenges).

## Debugging account revocation

Vault, via the [tidy mechanics](/vault/api-docs/secret/pki#tidy_acme), will
periodically remove stale accounts.

### Symptoms

When Vault has removed an account that it has deemed stale, if a client
attempts to reuse this account, an error will occur such as:

> The client lacks sufficient authorization: account in status: revoked

### Resolution

Refer to the ACME client's documentation for removing cached local
configuration and setup a new account, specifying any EABs as required.

## Tutorial

Refer to the [Build Your Own Certificate Authority (CA)](/vault/tutorials/secrets-management/pki-engine)
guide for a step-by-step tutorial.

Have a look at the [PKI Secrets Engine with Managed Keys](/vault/tutorials/enterprise/managed-key-pki)
for more about how to use externally managed keys with PKI.

## API

The PKI secrets engine has a full HTTP API. Please see the
[PKI secrets engine API](/vault/api-docs/secret/pki) for more
details.
